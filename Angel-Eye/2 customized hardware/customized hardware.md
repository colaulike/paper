# Angel-Eye: A Complete Design Flow for Mapping CNN onto Customized Hardware  

## remark

这篇文章大体和1一致，只是更加简练。

## 摘要

目前CNN朝着嵌入式平台实现快速部署和高能效的方向发展。本文对此提出了一个可编程灵活的CNN处理器结构，包括编译工具和运行环境。

## 1 简介

想要在硬件上实现CNN，神经网络就要朝着硬件友好的方向发展，并且拥有高效、高灵活性的结构。然后关于讲软件模型映射到硬件上，过去往往是人工完成的，CNN的多样性让这个工作给硬件工程师带来了不小的挑战。我们需要一个映射工具来连接软件模型和硬件结构。映射工具有两种选择：

* 针对特定网络自动生成硬件代码
* 使用一个灵活的硬件结构，将映射工作交给软件（本文使用的方法）:question:怎么做？

本文中提出的完整设计流程包括

+ 数据量化策略
+ 参数化和运行时可配置的硬件结构
+ 指令集和编译器

## 3 相关研究

### B CNN加速器

CNN加速器设计的关键在于对每一层循环的展开策略。目前固定的循环展开策略常常应用于CNN加速器设计。而可配置的循环展开在数据路由上会花费更多，但是可以更好地适应不同的网络拓扑结构。

## 4 工序流描述

流程如下图：

![3](customized%20hardware.assets/3.png)

### A 数据量化

这一部分内容和1的内容基本一样，不再赘述。

注意我们的优化目标是将定点数网络和浮点数网络最后一层的输出之间的残留误差降到最低，找到每一层数据小数点的最佳位置。具体流程如下图：

![4](customized%20hardware.assets/4.png)

### B 硬件结构

![5](customized%20hardware.assets/5.png)

+ **PE array**：PE阵列里实现了两级并行：PE之间和PE内部。不同的PE之间分享同一个输入通道，并使用不同的核来并行地计算不同的输出通道，具体内部结构如下图:

  ![6](customized%20hardware.assets/6.png)

   在每个PE内部，不同的卷积计算器对不同的输入通道并行地计算2维的卷积。每一个卷积器使用了线缓存设计（详情见：Reconfigurable pipelined 2-d convolvers for fast digital signal processing  ）并且达成了核层次的并行。我们采用的核的大小是3×3，这是目前最前沿CNN最常用的核的大小。它也可以通过padding支持更小的卷积核，也可以通过分时多路传输支持更大的卷积核。PE和卷积器的数量都进行了参数化处理来适应不同的平台。

+ **片上缓存**：这部分用外部存储分割PE阵列。这意味着数据I/O和计算可以并行。如果输出通道需要不止一轮计算，输出缓存也会将中间结果提供给PE阵列。我们引入了一个二维描述接口来管理数据，这能使用户完全利用片上缓存。例如，通过手动将地址空间分为乒和乓，那么就可以实现乒乓策略。对于较小的层，所有输入通道可以加载到片上。这就减少了冗余的外部存储接触。

+ **外部存储**：对于前沿的CNN，片上缓存往往是不够存储所有的参数和数据的。外部存储会用于保存所有网络的参数和每一层的结果。

+ **控制器**：这一个部分接收和翻译指令，并将指令发送到其他三个部分。控制器监控每一个部分的工作状态并判断能否发送下一条指令。因此，主机可以通过一个简单的FIFO界面向控制器发送生成的指令，检查控制器内的寄存器就可以判断工作是否完成。下图展示了这个部分的结构：

  ![7](customized%20hardware.assets/7.png)

### C 指令集和编译器

对于本加速器，本文提出了三个指令：LOAD，SAVE，CALC，对应和外部存储的IO交流和PE阵列完成的计算。指令里包含了存储在外部和片上缓存的数据的地址和大小。CALC指令里还可以设置padding、池化和数据位移。在这种情况下，只需要更换软件，硬件就能够支持不同的网络。

尽管与外部数据的IO可以和计算并行，潜在的数据依赖问题依然存在。我们在每个指令里设置了三个标志位来指示当前这个指令是否依赖于上一个之前的LOAD或者CLAC或者SAVE指令。因此安排策略可以在计算期间完成，运行期间不会对主机造成额外的工作负担。

编译器的作用是将一个描述神经网络的文件转换成硬件指令。对于每一个层，编译器首先优化计算时间。如果存在多个优化选择，它将会尝试减少和外部存储的交流来降低功耗和带宽开销。编译器也是参数化的，以支持不同的硬件设计。

